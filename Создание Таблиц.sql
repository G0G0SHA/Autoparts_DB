-- 1. Категории (ОК)
CREATE TABLE CATEGORIES (
    CATEGORY_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL UNIQUE,
    IS_ACTIVE CHAR(1) DEFAULT 'Y' CHECK (IS_ACTIVE IN ('Y', 'N'))
) TABLESPACE TS_PRODUCTS;

-- 3. Поставщики (ОК)
CREATE TABLE SUPPLIERS (
    SUPPLIER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    COMPANY_NAME VARCHAR2(100) NOT NULL UNIQUE,
    PHONE VARCHAR2(20),
    EMAIL VARCHAR2(100),
    IS_ACTIVE CHAR(1) DEFAULT 'Y' CHECK (IS_ACTIVE IN ('Y', 'N'))
) TABLESPACE TS_PRODUCTS;

-- 4. Пользователи 
CREATE TABLE USERS (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USERNAME VARCHAR2(50) UNIQUE NOT NULL,
    PASSWORD_HASH VARCHAR2(64) NOT NULL,
    ROLE VARCHAR2(20) DEFAULT 'user' CHECK (ROLE IN ('admin','manager','user')),
    FIRST_NAME VARCHAR2(50),
    LAST_NAME VARCHAR2(50),
    PHONE VARCHAR2(20),
    EMAIL VARCHAR2(100) UNIQUE,
    IS_BLOCKED CHAR(1) DEFAULT 'N' CHECK (IS_BLOCKED IN ('Y', 'N')),
    REGISTERED_DATE DATE DEFAULT SYSDATE,
    IS_ACTIVE CHAR(1) DEFAULT 'Y' CHECK (IS_ACTIVE IN ('Y', 'N'))
) TABLESPACE TS_CORE;

-- 5. Товары (ОК)
CREATE TABLE PRODUCTS (
    PRODUCT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL UNIQUE,
    CATEGORY_ID NUMBER NOT NULL,
    SUPPLIER_ID NUMBER NOT NULL,
    PRICE NUMBER(10,2) NOT NULL,
    QUANTITY_IN_STOCK NUMBER DEFAULT 0 NOT NULL,
    IS_ACTIVE CHAR(1) DEFAULT 'Y' CHECK (IS_ACTIVE IN ('Y', 'N')),
    DESCRIPTION VARCHAR2(1000),
    CONSTRAINT FK_PROD_CAT FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(CATEGORY_ID),
    CONSTRAINT FK_PROD_SUP FOREIGN KEY (SUPPLIER_ID) REFERENCES SUPPLIERS(SUPPLIER_ID)
) TABLESPACE TS_PRODUCTS;

-- 6. Корзина 
CREATE TABLE SHOPPING_CARTS (
    CART_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USER_ID NUMBER NOT NULL UNIQUE,
    STATUS CHAR(1) DEFAULT 'N' CHECK (STATUS IN ('Y', 'N')), 
    DELIVERY_ADDRESS VARCHAR2(255),
    DELIVERY_TIME DATE,
    CONSTRAINT FK_CART_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
) TABLESPACE TS_PRODUCTS;

-- 7. Позиции Корзины (ОК)
CREATE TABLE CART_ITEMS (
    CART_ITEM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    CART_ID NUMBER NOT NULL,
    PRODUCT_ID NUMBER NOT NULL,
    QUANTITY NUMBER NOT NULL CHECK (QUANTITY > 0),
    CONSTRAINT FK_CI_CART FOREIGN KEY (CART_ID) REFERENCES SHOPPING_CARTS(CART_ID) ON DELETE CASCADE,
    CONSTRAINT FK_CI_PROD FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(PRODUCT_ID)
) TABLESPACE TS_PRODUCTS;

-- 8. Заказы 
CREATE TABLE ORDERS (
    ORDER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USER_ID NUMBER NOT NULL,
    ORDER_DATE DATE DEFAULT SYSDATE NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'Processing' CHECK (STATUS IN ('Processing', 'Shipped', 'Completed', 'Cancelled')),
    TOTAL_AMOUNT NUMBER(10,2) DEFAULT 0,
    SHIPPING_ADDRESS VARCHAR2(255) NOT NULL, 
    DELIVERY_DATE DATE, 
    CONSTRAINT FK_ORD_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
) TABLESPACE TS_PRODUCTS;

-- 9. Позиции Заказа (ОК)
CREATE TABLE ORDER_ITEMS (
    ITEM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    ORDER_ID NUMBER NOT NULL,
    PRODUCT_ID NUMBER NOT NULL,
    QUANTITY NUMBER NOT NULL,
    PRICE_AT_PURCHASE NUMBER(10,2) NOT NULL,
    CONSTRAINT FK_OI_ORD FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID) ON DELETE CASCADE,
    CONSTRAINT FK_OI_PROD FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(PRODUCT_ID)
) TABLESPACE TS_PRODUCTS;

-- 10. Логи (ОК)
CREATE TABLE ACTIVITY_LOGS (
    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    USERNAME VARCHAR2(50),
    ACTION VARCHAR2(100),
    DETAILS VARCHAR2(4000),
    LOG_DATE DATE DEFAULT SYSDATE
) TABLESPACE TS_ARCHIVE;

-- Индексы для оптимизации
CREATE INDEX IDX_PROD_CAT ON PRODUCTS(CATEGORY_ID);
CREATE INDEX IDX_PROD_SUP ON PRODUCTS(SUPPLIER_ID); -- Добавили для поставщиков
CREATE INDEX IDX_ORDER_USER ON ORDERS(USER_ID);
CREATE INDEX IDX_ORDER_DATE ON ORDERS(ORDER_DATE); -- Для отчетов по датам
CREATE INDEX IDX_CART_ITEMS_CART ON CART_ITEMS(CART_ID);
CREATE INDEX IDX_ORDER_ITEMS_ORDER ON ORDER_ITEMS(ORDER_ID);

CREATE INDEX IDX_PRODUCTS_NAME ON PRODUCTS(UPPER(NAME));
CREATE INDEX IDX_LOGS_DATE ON ACTIVITY_LOGS(LOG_DATE);

COMMIT;